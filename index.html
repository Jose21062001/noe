<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Control de Operaciones - Ing. JosÃ© CÃ³rdova</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      margin: 0; padding: 20px; background-color: #f4f7f6; color: #333;
    }
    .container {
      max-width: 1200px; margin: 0 auto; background: #fff; padding: 20px;
      border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    .login-container {
      max-width: 400px; margin: 100px auto; background: #fff; padding: 40px;
      border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); text-align: center;
    }
    .login-container h2 { color: #0056b3; margin-bottom: 30px; }
    .login-container input {
      width: 100%; padding: 12px; margin-bottom: 20px;
      border: 1px solid #ccc; border-radius: 4px; font-size: 1rem; box-sizing: border-box;
    }
    .login-container button {
      width: 100%; padding: 12px; background-color: #007bff; color: white;
      border: none; border-radius: 4px; font-size: 1rem; font-weight: 600; cursor: pointer;
    }
    .menu-container {
      max-width: 900px; margin: 50px auto; background: #fff; padding: 40px;
      border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .menu-container h1 { color: #0056b3; margin-top: 0; text-align: center; }
    .menu-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-top: 30px; }
    .menu-btn {
      padding: 25px; font-size: 1.1rem; font-weight: 600;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white; border: none; border-radius: 12px; cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    .menu-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.15); }
    .menu-btn.dashboard { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
    .menu-btn.mant { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
    .menu-btn.loan { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
    .menu-btn.plant { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
    .menu-btn.alerts { background: linear-gradient(135deg, #30cfd0 0%, #330867 100%); }
    
    .logout-btn {
      float: right; padding: 8px 15px; background-color: #6c757d; color: white;
      border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem;
    }
    form {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px; margin-bottom: 20px; padding: 20px;
      border: 1px solid #ddd; border-radius: 8px;
    }
    form div { display: flex; flex-direction: column; }
    label { margin-bottom: 5px; font-weight: 600; }
    input, select, textarea { padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 1rem; }
    textarea { resize: vertical; min-height: 60px; }
    .form-actions { grid-column: 1 / -1; text-align: right; }
    button.primary { background-color: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; }
    button.secondary { background-color: #6c757d; color: white; margin-right: 10px; padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; }
    button.edit { background-color: #ffc107; color: #333; margin-right: 5px; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; }
    button.delete { background-color: #dc3545; color: white; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; }
    button.report { background-color: #17a2b8; color: white; margin-right: 5px; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; }
    button.whatsapp { background-color: #25D366; color: white; margin-right: 5px; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.9rem; }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: left; vertical-align: top; }
    th { background-color: #f2f2f2; font-weight: 700; }
    .accessory-grid { grid-column: 1 / -1; border: 1px solid #ccc; border-radius: 4px; padding: 15px; }
    .accessory-grid-items { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; }
    .acc-item { display: flex; gap: 10px; align-items: center; }
    .header-info-equipo {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px;
      display: flex; justify-content: space-between; align-items: center;
    }
    .signature-container { margin-top: 40px; display: flex; flex-direction: column; align-items: center; gap: 10px; }
    .profile-link { display: flex; align-items: center; gap: 10px; text-decoration: none; color: #555; font-weight: 600; }
    .profile-pic { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; border: 2px solid #007bff; }
    .stats-summary { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
    .stat-pill { 
      background: #fff; padding: 15px 20px; border-radius: 12px; font-size: 0.9rem; 
      font-weight: bold; border: 2px solid #eee; box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      transition: all 0.2s; cursor: pointer;
    }
    .stat-pill:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.12); }
    
    .alert-badge {
      background: #dc3545; color: white; border-radius: 50%;
      width: 24px; height: 24px; display: inline-flex; align-items: center;
      justify-content: center; font-size: 0.75rem; font-weight: bold;
      margin-left: 10px; animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
    
    .chart-container { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .chart-title { font-size: 1.2rem; font-weight: bold; margin-bottom: 15px; color: #333; }
    
    .signature-pad {
      border: 2px solid #ddd; border-radius: 4px; cursor: crosshair;
      background: white; touch-action: none;
    }
    .signature-controls { margin-top: 10px; display: flex; gap: 10px; }
    
    .modal {
      display: none; position: fixed; z-index: 1000; left: 0; top: 0;
      width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
      background-color: #fefefe; margin: 5% auto; padding: 30px;
      border-radius: 8px; width: 90%; max-width: 600px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
    .close:hover { color: #000; }
  </style>

  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>

  <div class="login-container" id="login-screen">
    <h2>ğŸ”§ Control de Operaciones </h2>
    <form id="login-form" style="display:block; border:none; padding:0; box-shadow:none;">
      <input type="email" id="email-input" placeholder="Correo electrÃ³nico" required>
      <input type="password" id="password-input" placeholder="ContraseÃ±a" required>
      <button type="submit" id="login-btn">Ingresar</button>
      <p id="error-message" style="color:red; display:none; margin-top:10px;">âŒ Datos incorrectos</p>
    </form>
  </div>

  <div class="menu-container" id="main-menu" style="display: none;">
    <h1>Panel de Control</h1>
    <p style="text-align: center; color: #666; margin-bottom: 30px;">Cuenta:<span id="user-email" style="font-weight: bold;"></span></p>
    
    <div style="margin: 20px 0;">
      <input type="search" id="main-search" placeholder="ğŸ” Buscar por cÃ³digo o cliente..." 
             style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem; box-sizing: border-box;">
    </div>
    
    <div id="search-results" style="display: none; background: #f9f9f9; padding: 20px; border-radius: 8px; margin-bottom: 20px; max-height: 400px; overflow-y: auto;">
      <h3 style="margin-top: 0;">Resultados de bÃºsqueda:</h3>
      <div id="results-container"></div>
    </div>
    
    <div class="menu-grid">
      <button class="menu-btn dashboard" onclick="showDashboard()">ğŸ“Š Dashboard</button>
      <button class="menu-btn mant" onclick="showMaintenance()">ğŸ”§ Mantenimiento</button>
      <button class="menu-btn loan" onclick="showLoans()">ğŸ“¦ GestiÃ³n Dispensadores</button>
      <button class="menu-btn plant" onclick="showPlant()">ğŸ­ Planta</button>
      <button class="menu-btn" style="background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);" onclick="showReparto()">ğŸšš Reparto</button>
      <button class="menu-btn alerts" onclick="showAlerts()">ğŸ”” Alertas<span id="alert-count" class="alert-badge" style="display:none;">0</span></button>
    </div>
    
    <button class="logout-btn" onclick="logout()" style="float:none; margin-top:30px; width: 100%;">Cerrar SesiÃ³n</button>
    
    <div class="signature-container">
      <a href="https://.com" target="_blank" class="profile-link">
        <img src="https://i.ibb.co/5Wn2vmD1/Whats-App-Image-2025-12-28-at-10-08-57.jpg" alt="Ing. JosÃ© CÃ³rdova" class="profile-pic">
        <span>DiseÃ±ado por Ing. JosÃ© CÃ³rdova</span>
      </a>
    </div>
  </div>

  <!-- DASHBOARD -->
  <div id="dashboard-app" style="display: none;">
    <div class="container">
      <button class="logout-btn" onclick="logout()">Cerrar SesiÃ³n</button>
      <button class="secondary" onclick="showMenu()" style="float:left;">â†©ï¸ MenÃº</button>
      <h1 style="clear:both; padding-top:20px;">ğŸ“Š Dashboard</h1>
      
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 25px;">
        <div class="stat-pill" style="border-left: 5px solid #007bff;">
          <div style="font-size: 1.5rem; color: #007bff;">ğŸ“¦</div>
          <div style="font-size: 0.75rem; color: #666;">Total Mantenimientos</div>
          <div style="font-size: 1.3rem; margin-top: 3px;" id="dash-total-mant">0</div>
        </div>
        <div class="stat-pill" style="border-left: 5px solid #ffc107;">
          <div style="font-size: 1.5rem; color: #ffc107;">â³</div>
          <div style="font-size: 0.75rem; color: #666;">Pendientes</div>
          <div style="font-size: 1.3rem; margin-top: 3px;" id="dash-pendientes">0</div>
        </div>
        <div class="stat-pill" style="border-left: 5px solid #28a745;">
          <div style="font-size: 1.5rem; color: #28a745;">âœ…</div>
          <div style="font-size: 0.75rem; color: #666;">Completados</div>
          <div style="font-size: 1.3rem; margin-top: 3px;" id="dash-completados">0</div>
        </div>
        <div class="stat-pill" style="border-left: 5px solid #17a2b8;">
          <div style="font-size: 1.5rem; color: #17a2b8;">ğŸ”„</div>
          <div style="font-size: 0.75rem; color: #666;">PrÃ©stamos Activos</div>
          <div style="font-size: 1.3rem; margin-top: 3px;" id="dash-prestamos">0</div>
        </div>
      </div>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
        <div class="chart-container">
          <div class="chart-title">Estado de Equipos</div>
          <canvas id="chart-estados" height="180"></canvas>
        </div>
        <div class="chart-container">
          <div class="chart-title">Tendencia Ãšltimos 6 Meses</div>
          <canvas id="chart-tendencia" height="180"></canvas>
        </div>
      </div>

      <div class="chart-container" style="margin-bottom: 20px;">
        <div class="chart-title">Top 10 Clientes</div>
        <canvas id="chart-clientes" height="120"></canvas>
      </div>

      <button class="primary" onclick="exportarTodoExcel()">ğŸ“¥ Exportar Todo a Excel</button>
    </div>
  </div>

  <!-- ALERTAS -->
  <div id="alerts-app" style="display: none;">
    <div class="container">
      <button class="logout-btn" onclick="logout()">Cerrar SesiÃ³n</button>
      <button class="secondary" onclick="showMenu()" style="float:left;">â†©ï¸ MenÃº</button>
      <h1 style="clear:both; padding-top:20px;">ğŸ”” Centro de Alertas</h1>
      
      <div id="alerts-container"></div>
    </div>
  </div>

  <!-- MANTENIMIENTO -->
  <div id="maintenance-app" style="display: none;">
    <div class="container">
      <button class="logout-btn" onclick="logout()">Cerrar SesiÃ³n</button>
      <button class="secondary" onclick="showMenu()" style="float:left;">â†©ï¸ MenÃº</button>
      <button class="primary" onclick="exportarMantenimientoExcel()" style="float:right; margin-left:10px;">ğŸ“¥ Excel</button>
      <h1 style="clear:both; padding-top:20px;">Mantenimiento de dispensadores</h1>
      <div id="editing-indicator" style="display:none; background:#fff3cd; padding:10px; margin-bottom:10px;"><strong>âš ï¸ Editando registro</strong><button onclick="cancelEdit()" style="float:right;">Cancelar</button></div>
      
      <form id="form-mantenimiento">
        <div><label>Fecha</label><input type="date" id="fecha" required></div>
        <div><label>CÃ³digo</label><input type="text" id="codigo" required></div>
        <div><label>Cliente</label><input type="text" id="cliente" required></div>
        <div><label>Contacto</label><input type="text" id="contacto"></div>
        <div><label>TelÃ©fono</label><input type="tel" id="telefono" placeholder="+51 999 999 999"></div>
        <div><label>Costo (S/)</label><input type="number" step="0.01" id="costo" placeholder="0.00"></div>
        <div style="grid-column:1/-1"><label>Motivo</label><textarea id="motivo" required></textarea></div>
        <div style="grid-column:1/-1"><label>Observaciones</label><textarea id="observaciones"></textarea></div>
        <div style="grid-column:1/-1"><label>ReparaciÃ³n</label><textarea id="reparacion"></textarea></div>
        <div>
          <label>Estado</label>
          <select id="estado">
            <option value="recibido">Recibido</option>
            <option value="listo">Listo</option>
            <option value="entregado-almacen">Entregado a AlmacÃ©n</option>
            <option value="entregado-cliente">Entregado al Cliente</option>
          </select>
        </div>
        <div id="div-fecha-almacen" style="display:none;"><label>Fecha E. AlmacÃ©n</label><input type="date" id="f-almacen"></div>
        <div id="div-fecha-cliente" style="display:none;"><label>Fecha E. Cliente</label><input type="date" id="f-cliente"></div>
        <div class="form-actions">
          <button type="button" class="secondary" onclick="abrirFirma()">âœï¸ Firma</button>
          <button type="submit" class="primary" id="submit-btn">Guardar Registro</button>
        </div>
      </form>
      
      <div class="stats-summary">
        <div class="stat-pill" style="border-left: 5px solid #ffc107; cursor: pointer;" onclick="filterByStatus('recibido')">Recibidos: <span id="count-recibido">0</span></div>
        <div class="stat-pill" style="border-left: 5px solid #17a2b8; cursor: pointer;" onclick="filterByStatus('entregado-almacen')">En AlmacÃ©n: <span id="count-almacen">0</span></div>
        <div class="stat-pill" style="border-left: 5px solid #28a745; cursor: pointer;" onclick="filterByStatus('entregado-cliente')">Entregados: <span id="count-cliente">0</span></div>
        <div class="stat-pill" style="border-left: 5px solid #6c757d; cursor: pointer;" onclick="filterByStatus('todos')">Todos</div>
      </div>

      <div class="controls"><input type="search" id="search-box" placeholder="Buscar por cÃ³digo o cliente..."></div>
      <div style="overflow-x:auto;">
        <table id="tabla-registros">
          <thead><tr><th>Fecha</th><th>CÃ³digo</th><th>Cliente</th><th>Contacto</th><th>Costo</th><th>Motivo</th><th>Estado</th><th>Acciones</th></tr></thead>
          <tbody id="tabla-body"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- GESTIÃ“N DE DISPENSADORES (STOCK + PRÃ‰STAMOS) -->
  <div id="loan-app" style="display: none;">
    <div class="container">
      <button class="logout-btn" onclick="logout()">Cerrar SesiÃ³n</button>
      <button class="secondary" onclick="showMenu()" style="float:left;">â†©ï¸ MenÃº</button>
      <button class="primary" onclick="exportarDispensadoresExcel()" style="float:right; margin-left:10px;">ğŸ“¥ Excel</button>
      <h1 style="clear:both; padding-top:20px;">ğŸ“¦ GestiÃ³n de Dispensadores</h1>
      
      <!-- TABS -->
      <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #ddd;">
        <button id="tab-stock" class="tab-btn" onclick="switchTab('stock')" style="padding: 12px 25px; border: none; background: #007bff; color: white; font-weight: bold; cursor: pointer; border-radius: 8px 8px 0 0;">
          ğŸ“¦ Stock Disponible
        </button>
        <button id="tab-prestamos" class="tab-btn" onclick="switchTab('prestamos')" style="padding: 12px 25px; border: none; background: #f0f0f0; color: #666; font-weight: bold; cursor: pointer; border-radius: 8px 8px 0 0;">
          ğŸ“¤ PrÃ©stamos Activos
        </button>
      </div>

      <!-- SECCIÃ“N STOCK -->
      <div id="seccion-stock">
        <div class="stats-summary">
          <div class="stat-pill" style="border-left: 5px solid #28a745;">
            Total en Stock: <span id="count-stock">0</span>
          </div>
          <div class="stat-pill" style="border-left: 5px solid #17a2b8;">
            En PrÃ©stamo: <span id="count-prestados">0</span>
          </div>
        </div>

        <div id="editing-indicator-stock" style="display:none; background:#fff3cd; padding:10px; margin-bottom:10px;">
          <strong>âš ï¸ Editando equipo</strong><button onclick="cancelEditStock()" style="float:right;">Cancelar</button>
        </div>

        <form id="form-stock">
          <div><label>CÃ³digo Interno</label><input type="text" id="s-codigo" required></div>
          <div><label>Modelo/DescripciÃ³n</label><input type="text" id="s-modelo" required></div>
          <div><label>Estado</label><select id="s-estado"><option>Nuevo</option><option>Usado - Excelente</option><option>Usado - Bueno</option></select></div>
          <div><label>Fecha Ingreso</label><input type="date" id="s-fecha" required></div>
          <div style="grid-column:1/-1"><label>Observaciones</label><textarea id="s-obs"></textarea></div>
          
          <fieldset class="accessory-grid">
            <legend>Accesorios Incluidos:</legend>
            <div class="accessory-grid-items">
              <div class="acc-item"><input type="checkbox" id="s-acc-embudo"><label>Embudo</label></div>
              <div class="acc-item"><input type="checkbox" id="s-acc-pinza"><label>Pinza</label></div>
              <div class="acc-item"><input type="checkbox" id="s-acc-rejilla"><label>Rejilla</label></div>
              <div class="acc-item"><input type="checkbox" id="s-acc-cano-caliente"><label>CaÃ±o Caliente</label></div>
              <div class="acc-item"><input type="checkbox" id="s-acc-cano-tiempo"><label>CaÃ±o Tiempo</label></div>
              <div class="acc-item"><input type="checkbox" id="s-acc-cano-fria"><label>CaÃ±o Frio</label></div>
              <div class="acc-item"><input type="checkbox" id="s-acc-tapa-superior"><label>Tapa Superior</label></div>
              <div class="acc-item"><input type="checkbox" id="s-acc-tapa-frontal"><label>Tapa Frontal</label></div>
              <div class="acc-item"><input type="checkbox" id="s-acc-tapa-lateral"><label>Tapas Laterales</label></div>
            </div>
          </fieldset>
          
          <div class="form-actions">
            <button type="submit" class="primary">ğŸ’¾ Guardar en Stock</button>
          </div>
        </form>

        <div class="controls"><input type="search" id="s-search" placeholder="Buscar por cÃ³digo o modelo..."></div>
        <div style="overflow-x:auto;">
          <table id="tabla-stock">
            <thead><tr><th>CÃ³digo</th><th>Modelo</th><th>Estado</th><th>Fecha Ingreso</th><th>Accesorios</th><th>Status</th><th>Acciones</th></tr></thead>
            <tbody id="tabla-stock-body"></tbody>
          </table>
        </div>
      </div>

      <!-- SECCIÃ“N PRÃ‰STAMOS -->
      <div id="seccion-prestamos" style="display: none;">
        <div id="editing-indicator-prestamo" style="background:#fff3cd; padding:10px; display:none; margin-bottom:10px;">
          <strong>âš ï¸ Editando</strong><button onclick="cancelEditPrestamo()" style="float:right;">Cancelar</button>
        </div>
        
        <form id="form-prestamo">
          <div><label>Fecha PrÃ©stamo</label><input type="date" id="p-fecha" required></div>
          <div>
            <label>Seleccionar de Stock</label>
            <select id="p-desde-stock" onchange="cargarDesdeStock()">
              <option value="">-- Seleccionar equipo --</option>
            </select>
          </div>
          <div><label>CÃ³digo</label><input type="text" id="p-codigo" required></div>
          <div><label>Cliente</label><input type="text" id="p-cliente" required></div>
          <div><label>TelÃ©fono</label><input type="tel" id="p-telefono" placeholder="+51 999 999 999"></div>
          <div><label>Estado</label><select id="p-estado"><option>Nuevo</option><option>Usado</option></select></div>
          <div style="grid-column:1/-1"><label>Observaciones</label><textarea id="p-obs"></textarea></div>
          
          <fieldset class="accessory-grid">
            <legend>Accesorios:</legend>
            <div class="accessory-grid-items">
              <div class="acc-item"><input type="checkbox" id="acc-embudo"><label>Embudo</label></div>
              <div class="acc-item"><input type="checkbox" id="acc-pinza"><label>Pinza</label></div>
              <div class="acc-item"><input type="checkbox" id="acc-rejilla"><label>Rejilla</label></div>
              <div class="acc-item"><input type="checkbox" id="acc-cano-caliente"><label>CaÃ±o Caliente</label></div>
              <div class="acc-item"><input type="checkbox" id="acc-cano-tiempo"><label>CaÃ±o Tiempo</label></div>
              <div class="acc-item"><input type="checkbox" id="acc-cano-fria"><label>CaÃ±o Frio</label></div>
              <div class="acc-item"><input type="checkbox" id="acc-tapa-superior"><label>Tapa Superior</label></div>
              <div class="acc-item"><input type="checkbox" id="acc-tapa-frontal"><label>Tapa Frontal</label></div>
              <div class="acc-item"><input type="checkbox" id="acc-tapa-lateral"><label>Tapas Laterales</label></div>
            </div>
          </fieldset>
          <div class="form-actions">
            <button type="button" class="secondary" onclick="abrirFirmaPrestamo()">âœï¸ Firma Cliente</button>
            <button type="submit" class="primary" id="p-submit">Guardar PrÃ©stamo</button>
          </div>
        </form>
        
        <div class="controls"><input type="search" id="p-search" placeholder="Buscar prÃ©stamo..."></div>
        <div style="overflow-x:auto;">
          <table id="tabla-prestamos">
            <thead><tr><th>Fecha</th><th>CÃ³digo</th><th>Cliente</th><th>TelÃ©fono</th><th>Estado</th><th>Accesorios</th><th>Acciones</th></tr></thead>
            <tbody id="tabla-prestamos-body"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- STOCK -->
  <div id="stock-app" style="display: none;"></div>

  <!-- REPARTO -->
  <div id="reparto-app" style="display: none;">
    <div class="container">
      <button class="logout-btn" onclick="logout()">Cerrar SesiÃ³n</button>
      <button class="secondary" onclick="showMenu()" style="float:left;">â†©ï¸ MenÃº</button>
      <h1 style="clear:both; padding-top:20px;">ğŸšš GestiÃ³n de Reparto</h1>
      
      <!-- TABS -->
      <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #ddd;">
        <button id="tab-crear-ruta" class="tab-btn" onclick="switchTabReparto('crear')" style="padding: 12px 25px; border: none; background: #007bff; color: white; font-weight: bold; cursor: pointer; border-radius: 8px 8px 0 0;">
          ğŸ“‹ Crear Ruta
        </button>
        <button id="tab-repartidor" class="tab-btn" onclick="switchTabReparto('repartidor')" style="padding: 12px 25px; border: none; background: #f0f0f0; color: #666; font-weight: bold; cursor: pointer; border-radius: 8px 8px 0 0;">
          ğŸšš Repartidor
        </button>
      </div>

      <!-- SECCIÃ“N CREAR RUTA -->
      <div id="seccion-crear-ruta">
        <h2>ğŸ“ Nueva Ruta de Entrega</h2>
        
        <form id="form-ruta-base" style="background: #f9f9f9; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
          <div><label>ğŸ“… Fecha</label><input type="date" id="ruta-fecha" required></div>
          <div><label>ğŸš— VehÃ­culo</label><input type="text" id="ruta-vehiculo" placeholder="Ej: Kia 1" required></div>
          <div><label>ğŸ”¢ Placa</label><input type="text" id="ruta-placa" placeholder="Ej: ABC-123" required></div>
          <div><label>ğŸ‘¥ Cantidad de Clientes</label><input type="number" id="ruta-num-clientes" min="1" max="20" placeholder="1-20" required></div>
          <div class="form-actions">
            <button type="button" class="primary" onclick="generarFormularioClientes()">â¡ï¸ Siguiente</button>
          </div>
        </form>

        <div id="formulario-clientes" style="display: none;">
          <h3>ğŸ“‹ Detalle de Entregas</h3>
          <div id="clientes-container"></div>
          <div style="margin-top: 20px; text-align: right;">
            <button class="secondary" onclick="cancelarRuta()">âŒ Cancelar</button>
            <button class="primary" onclick="guardarRuta()">ğŸ’¾ Guardar Ruta</button>
          </div>
        </div>

        <h3 style="margin-top: 40px;">ğŸ“Š Rutas Programadas Hoy</h3>
        <div id="rutas-hoy-container"></div>
      </div>

      <!-- SECCIÃ“N REPARTIDOR -->
      <div id="seccion-repartidor" style="display: none;">
        <h2>ğŸšš Panel del Repartidor</h2>
        
        <div style="background: #f9f9f9; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
          <label style="font-weight: bold; font-size: 1.1rem;">ğŸš— Selecciona tu vehÃ­culo:</label>
          <select id="select-vehiculo-repartidor" style="width: 100%; padding: 12px; margin-top: 10px; font-size: 1rem; border: 2px solid #007bff; border-radius: 8px;" onchange="mostrarFormularioEquipo()">
            <option value="">-- Seleccionar vehÃ­culo --</option>
          </select>
        </div>

        <div id="form-equipo-trabajo" style="display: none; background: #fff3cd; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
          <h3 style="margin-top: 0;">ğŸ‘¥ Datos del Equipo de Trabajo</h3>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div>
              <label style="font-weight: bold; display: block; margin-bottom: 5px;">ğŸ‘¨â€âœˆï¸ Nombre del Chofer:</label>
              <input type="text" id="nombre-chofer" placeholder="Ej: Juan PÃ©rez" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;" required>
            </div>
            <div>
              <label style="font-weight: bold; display: block; margin-bottom: 5px;">ğŸ‘· Nombre del Ayudante:</label>
              <input type="text" id="nombre-ayudante" placeholder="Ej: Carlos LÃ³pez" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;" required>
            </div>
          </div>
          <button class="primary" onclick="confirmarEquipoYCargarRuta()" style="margin-top: 15px; width: 100%;">âœ… Confirmar e Iniciar Ruta</button>
        </div>

        <div id="ruta-repartidor-container" style="display: none;">
          <div class="header-info-equipo" style="background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);">
            <div>
              <h2 id="ruta-vehiculo-nombre" style="margin:0;"></h2>
              <p id="ruta-fecha-info" style="margin:0; opacity:0.9;"></p>
              <p id="ruta-equipo-info" style="margin:5px 0 0 0; opacity:0.9; font-size: 0.95rem;"></p>
            </div>
            <button class="primary" onclick="finalizarRuta()" style="background:#28a745;">âœ… Finalizar Ruta</button>
          </div>

          <div id="entregas-container"></div>
        </div>

        <h3 style="margin-top: 40px;">ğŸ“œ Historial de Entregas</h3>
        <button class="primary" onclick="exportarHistorialDia()" style="margin-bottom: 15px;">ğŸ“¥ Exportar Hoy a Excel</button>
        <div style="overflow-x: auto;">
          <table id="tabla-historial-reparto">
            <thead><tr><th>Fecha</th><th>VehÃ­culo</th><th>Chofer</th><th>Total Clientes</th><th>Entregados</th><th>Bidones</th><th>Acciones</th></tr></thead>
            <tbody id="tabla-historial-body"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- PLANTA -->
  <div id="plant-app" style="display: none;" class="container">
    <button class="secondary" onclick="showMenu()">â†©ï¸ MenÃº</button>
    
    <div id="plant-view-master">
      <h1>Mantenimiento de Planta</h1>
      <form id="form-nuevo-equipo-planta">
        <div><label>CÃ³digo Equipo</label><input type="text" id="pl-master-codigo" required></div>
        <div><label>Nombre Equipo</label><input type="text" id="pl-master-nombre" required></div>
        <div class="form-actions"><button type="submit" class="primary">+ Registrar Equipo</button></div>
      </form>
      <table id="tabla-maestro-planta">
        <thead><tr><th>CÃ³digo</th><th>Nombre del Equipo</th><th>Acciones</th></tr></thead>
        <tbody id="tabla-maestro-body"></tbody>
      </table>
    </div>

    <div id="plant-view-detail" style="display:none;">
      <button class="secondary" onclick="backToPlantMaster()">â¬… Volver</button>
      <div class="header-info-equipo">
        <div><h2 id="pl-display-nombre" style="margin:0;"></h2><p id="pl-display-codigo" style="margin:0; opacity:0.8;"></p></div>
        <button class="report" id="btn-exportar-historial-pdf" style="background:#28a745;">ğŸ“„ PDF</button>
      </div>
      <form id="form-historial-planta">
        <div><label>Fecha</label><input type="date" id="pl-hist-fecha" required></div>
        <div><label>TÃ©cnico Responsable</label><input type="text" id="pl-hist-tecnico" required></div>
        <div><label>Costo (S/)</label><input type="number" step="0.01" id="pl-hist-costo" placeholder="0.00"></div>
        <div style="grid-column:1/-1"><label>Motivo de Falla</label><textarea id="pl-hist-motivo" required></textarea></div>
        <div style="grid-column:1/-1"><label>Trabajo Realizado</label><textarea id="pl-hist-trabajo" required></textarea></div>
        <div class="form-actions"><button type="submit" class="primary">Guardar Registro</button></div>
      </form>
      <table id="tabla-historial-planta">
        <thead><tr><th>Fecha</th><th>TÃ©cnico</th><th>Costo</th><th>Motivo</th><th>Trabajo</th><th>Acciones</th></tr></thead>
        <tbody id="tabla-historial-body"></tbody>
      </table>
    </div>
  </div>

  <!-- MODAL FIRMA -->
  <div id="firma-modal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="cerrarFirma()">&times;</span>
      <h2>âœï¸ Firma Digital</h2>
      <canvas id="signature-pad" class="signature-pad" width="500" height="200"></canvas>
      <div class="signature-controls">
        <button class="secondary" onclick="limpiarFirma()">ğŸ—‘ï¸ Limpiar</button>
        <button class="primary" onclick="guardarFirma()">ğŸ’¾ Guardar Firma</button>
      </div>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDXjsEFJ4eS7T3HBZH1f-PioCZf-94INVA",
      authDomain: "mantenimiento-dispensador.firebaseapp.com",
      projectId: "mantenimiento-dispensador",
      storageBucket: "mantenimiento-dispensador.firebasestorage.app",
      messagingSenderId: "68227657642",
      appId: "1:68227657642:web:dc97cf988fba73159405d3"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const colMant = db.collection("mantenimiento");
    const colPrest = db.collection("prestamos");
    const colPlantaEquipos = db.collection("planta_maestro");
    const colPlantaHistorial = db.collection("planta_historial");
    const colStock = db.collection("stock");
    const colRutas = db.collection("rutas");
    const colHistorialReparto = db.collection("historial_reparto");

    let currentUser = null;
    let currentSignature = null;
    let currentSignaturePrestamo = null;
    let allData = { mant: [], prest: [], planta: [], stock: [], rutas: [] };
    let currentRutaId = null;
    let editandoRuta = false;
    let rutaIdEditar = null;

    function hideAll() {
      document.getElementById('login-screen').style.display='none';
      document.getElementById('main-menu').style.display='none';
      document.getElementById('dashboard-app').style.display='none';
      document.getElementById('maintenance-app').style.display='none';
      document.getElementById('loan-app').style.display='none';
      document.getElementById('plant-app').style.display='none';
      document.getElementById('alerts-app').style.display='none';
      document.getElementById('reparto-app').style.display='none';
    }
    function showMenu() { hideAll(); document.getElementById('main-menu').style.display='block'; }
    function showDashboard() { hideAll(); document.getElementById('dashboard-app').style.display='block'; updateDashboard(); }
    function showMaintenance() { hideAll(); document.getElementById('maintenance-app').style.display='block'; }
    function showLoans() { hideAll(); document.getElementById('loan-app').style.display='block'; switchTab('stock'); actualizarSelectStock(); }
    function showPlant() { hideAll(); document.getElementById('plant-app').style.display='block'; backToPlantMaster(); }
    function showAlerts() { hideAll(); document.getElementById('alerts-app').style.display='block'; updateAlerts(); }
    function showReparto() { hideAll(); document.getElementById('reparto-app').style.display='block'; switchTabReparto('crear'); initReparto(); }
    function logout() { auth.signOut(); }

    // Sistema de tabs
    function switchTab(tab) {
      if(tab === 'stock') {
        document.getElementById('seccion-stock').style.display = 'block';
        document.getElementById('seccion-prestamos').style.display = 'none';
        document.getElementById('tab-stock').style.background = '#007bff';
        document.getElementById('tab-stock').style.color = 'white';
        document.getElementById('tab-prestamos').style.background = '#f0f0f0';
        document.getElementById('tab-prestamos').style.color = '#666';
      } else {
        document.getElementById('seccion-stock').style.display = 'none';
        document.getElementById('seccion-prestamos').style.display = 'block';
        document.getElementById('tab-stock').style.background = '#f0f0f0';
        document.getElementById('tab-stock').style.color = '#666';
        document.getElementById('tab-prestamos').style.background = '#007bff';
        document.getElementById('tab-prestamos').style.color = 'white';
        actualizarSelectStock();
      }
    }

    document.getElementById('login-form').onsubmit = e => {
      e.preventDefault();
      auth.signInWithEmailAndPassword(document.getElementById('email-input').value, document.getElementById('password-input').value)
        .catch(() => document.getElementById('error-message').style.display='block');
    };

    auth.onAuthStateChanged(user => { 
      if(user) {
        currentUser = user;
        document.getElementById('user-email').textContent = user.email;
        initMant(); 
        initPrest(); 
        initPlant();
        initStock();
        initMainSearch();
        limpiarHistorialAntiguo();
        showMenu(); 
      } else { 
        hideAll(); 
        document.getElementById('login-screen').style.display='block'; 
      }
    });

    function formatDate(s) { if(!s) return ""; const [y,m,d]=s.split('-'); return `${d}/${m}/${y}`; }

    // ===== BÃšSQUEDA GLOBAL =====
    function initMainSearch() {
      const searchInput = document.getElementById('main-search');
      const resultsDiv = document.getElementById('search-results');
      const resultsContainer = document.getElementById('results-container');
      
      searchInput.addEventListener('input', async () => {
        const term = searchInput.value.toLowerCase().trim();
        
        if (term.length < 2) {
          resultsDiv.style.display = 'none';
          return;
        }
        
        resultsContainer.innerHTML = '<p style="color: #666;">ğŸ” Buscando...</p>';
        resultsDiv.style.display = 'block';
        
        const allResults = [];
        
        const mantSnap = await colMant.get();
        mantSnap.forEach(doc => {
          const data = doc.data();
          if (data.codigo.toLowerCase().includes(term) || data.cliente.toLowerCase().includes(term)) {
            allResults.push({
              tipo: 'Mantenimiento', codigo: data.codigo, cliente: data.cliente,
              fecha: data.fecha, estado: data.estado, id: doc.id
            });
          }
        });
        
        const prestSnap = await colPrest.get();
        prestSnap.forEach(doc => {
          const data = doc.data();
          if (data.codigo.toLowerCase().includes(term) || data.cliente.toLowerCase().includes(term)) {
            allResults.push({
              tipo: 'PrÃ©stamo', codigo: data.codigo, cliente: data.cliente,
              fecha: data.fecha, estado: data.estadoGeneral, id: doc.id
            });
          }
        });
        
        const plantaSnap = await colPlantaEquipos.get();
        plantaSnap.forEach(doc => {
          const data = doc.data();
          if (data.codigo.toLowerCase().includes(term) || data.nombre.toLowerCase().includes(term)) {
            allResults.push({ tipo: 'Planta', codigo: data.codigo, cliente: data.nombre, id: doc.id });
          }
        });
        
        if (allResults.length === 0) {
          resultsContainer.innerHTML = '<p style="color: #999;">âŒ No se encontraron resultados</p>';
        } else {
          resultsContainer.innerHTML = allResults.map(r => `
            <div style="background: white; padding: 12px; margin-bottom: 10px; border-radius: 8px; border-left: 4px solid ${r.tipo === 'Mantenimiento' ? '#4facfe' : r.tipo === 'PrÃ©stamo' ? '#43e97b' : '#fa709a'}; cursor: pointer; transition: all 0.2s;" 
                 onmouseover="this.style.transform='translateX(5px)'" onmouseout="this.style.transform='translateX(0)'"
                 onclick="goToRecord('${r.tipo}', '${r.id}')">
              <div style="font-weight: bold; margin-bottom: 5px;">${r.tipo}: ${r.codigo}</div>
              <div style="color: #666; font-size: 0.9rem;">ğŸ‘¤ ${r.cliente}</div>
              ${r.fecha ? `<div style="color: #999; font-size: 0.85rem;">ğŸ“… ${formatDate(r.fecha)}</div>` : ''}
              ${r.estado ? `<div style="color: #666; font-size: 0.85rem;">ğŸ“Š ${r.estado}</div>` : ''}
            </div>
          `).join('');
        }
      });
    }
    
    window.goToRecord = (tipo, id) => {
      if (tipo === 'Mantenimiento') showMaintenance();
      else if (tipo === 'PrÃ©stamo') showLoans();
      else if (tipo === 'Planta') { showPlant(); setTimeout(() => openEquipoHistory(id), 100); }
    };

    // ===== DASHBOARD =====
    let charts = {};

    function updateDashboard() {
      const totalMant = allData.mant.length;
      const pendientes = allData.mant.filter(i => i.estado === 'recibido' || i.estado === 'listo').length;
      const completados = allData.mant.filter(i => i.estado === 'entregado-cliente').length;
      const prestamos = allData.prest.length;

      document.getElementById('dash-total-mant').textContent = totalMant;
      document.getElementById('dash-pendientes').textContent = pendientes;
      document.getElementById('dash-completados').textContent = completados;
      document.getElementById('dash-prestamos').textContent = prestamos;

      // GrÃ¡fico de Estados
      const estados = {
        'Recibido': allData.mant.filter(i => i.estado === 'recibido').length,
        'Listo': allData.mant.filter(i => i.estado === 'listo').length,
        'En AlmacÃ©n': allData.mant.filter(i => i.estado === 'entregado-almacen').length,
        'Entregado': allData.mant.filter(i => i.estado === 'entregado-cliente').length
      };

      if(charts.estados) charts.estados.destroy();
      const ctx1 = document.getElementById('chart-estados').getContext('2d');
      charts.estados = new Chart(ctx1, {
        type: 'doughnut',
        data: {
          labels: Object.keys(estados),
          datasets: [{
            data: Object.values(estados),
            backgroundColor: ['#ffc107', '#17a2b8', '#6c757d', '#28a745']
          }]
        },
        options: { 
          responsive: true, 
          maintainAspectRatio: true,
          plugins: {
            legend: { position: 'bottom', labels: { padding: 10, font: { size: 11 } } }
          }
        }
      });

      // Tendencia mensual
      const meses = {};
      allData.mant.forEach(i => {
        if(i.fecha) {
          const mes = i.fecha.substring(0, 7);
          meses[mes] = (meses[mes] || 0) + 1;
        }
      });
      const mesesOrdenados = Object.keys(meses).sort().slice(-6);

      if(charts.tendencia) charts.tendencia.destroy();
      const ctx2 = document.getElementById('chart-tendencia').getContext('2d');
      charts.tendencia = new Chart(ctx2, {
        type: 'line',
        data: {
          labels: mesesOrdenados,
          datasets: [{
            label: 'Equipos',
            data: mesesOrdenados.map(m => meses[m]),
            borderColor: '#667eea',
            backgroundColor: 'rgba(102, 126, 234, 0.1)',
            tension: 0.4,
            fill: true,
            borderWidth: 2
          }]
        },
        options: { 
          responsive: true, 
          maintainAspectRatio: true,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: { beginAtZero: true, ticks: { font: { size: 10 } } },
            x: { ticks: { font: { size: 10 } } }
          }
        }
      });

      // Top Clientes
      const clientes = {};
      allData.mant.forEach(i => {
        clientes[i.cliente] = (clientes[i.cliente] || 0) + 1;
      });
      const topClientes = Object.entries(clientes).sort((a,b) => b[1]-a[1]).slice(0, 10);

      if(charts.clientes) charts.clientes.destroy();
      const ctx3 = document.getElementById('chart-clientes').getContext('2d');
      charts.clientes = new Chart(ctx3, {
        type: 'bar',
        data: {
          labels: topClientes.map(c => c[0]),
          datasets: [{
            label: 'Equipos',
            data: topClientes.map(c => c[1]),
            backgroundColor: '#f5576c'
          }]
        },
        options: { 
          responsive: true, 
          maintainAspectRatio: true,
          indexAxis: 'y',
          plugins: {
            legend: { display: false }
          },
          scales: {
            x: { beginAtZero: true, ticks: { font: { size: 10 } } },
            y: { ticks: { font: { size: 10 } } }
          }
        }
      });
    }

    // ===== ALERTAS =====
    function updateAlerts() {
      const container = document.getElementById('alerts-container');
      const alertas = [];
      const hoy = new Date();

      allData.mant.forEach(i => {
        if(i.estado === 'recibido' && i.fecha) {
          const fechaRec = new Date(i.fecha);
          const dias = Math.floor((hoy - fechaRec) / (1000 * 60 * 60 * 24));
          if(dias > 7) {
            alertas.push({
              tipo: 'urgente',
              titulo: `âš ï¸ Equipo ${i.codigo} lleva ${dias} dÃ­as sin atender`,
              detalle: `Cliente: ${i.cliente}`,
              motivo: i.motivo,
              fecha: formatDate(i.fecha)
            });
          } else if(dias > 3) {
            alertas.push({
              tipo: 'advertencia',
              titulo: `â° Equipo ${i.codigo} lleva ${dias} dÃ­as en espera`,
              detalle: `Cliente: ${i.cliente}`,
              motivo: i.motivo,
              fecha: formatDate(i.fecha)
            });
          }
        }
      });

      const badge = document.getElementById('alert-count');
      if(alertas.length > 0) {
        badge.textContent = alertas.length;
        badge.style.display = 'inline-flex';
      } else {
        badge.style.display = 'none';
      }

      if(alertas.length === 0) {
        container.innerHTML = '<div style="text-align:center; padding: 40px; color: #28a745;"><h2>âœ… Todo en orden</h2><p>No hay alertas pendientes</p></div>';
      } else {
        container.innerHTML = alertas.map(a => `
          <div style="background: ${a.tipo === 'urgente' ? '#fff3cd' : '#d1ecf1'}; padding: 20px; margin-bottom: 15px; border-left: 5px solid ${a.tipo === 'urgente' ? '#ffc107' : '#17a2b8'}; border-radius: 8px;">
            <h3 style="margin: 0 0 10px 0;">${a.titulo}</h3>
            <p style="margin: 5px 0; color: #666;">${a.detalle}</p>
            <p style="margin: 10px 0; padding: 10px; background: rgba(0,0,0,0.05); border-radius: 4px;"><strong>Motivo:</strong> ${a.motivo}</p>
            <small style="color: #999;">ğŸ“… Recibido: ${a.fecha}</small>
          </div>
        `).join('');
      }
    }

    // ===== FIRMA DIGITAL =====
    let firmaCanvas, firmaCtx, dibujando = false;

    function abrirFirma() {
      document.getElementById('firma-modal').style.display = 'block';
      setupCanvas();
    }

    function abrirFirmaPrestamo() {
      document.getElementById('firma-modal').style.display = 'block';
      setupCanvas(true);
    }

    function setupCanvas(esPrestamo = false) {
      firmaCanvas = document.getElementById('signature-pad');
      firmaCtx = firmaCanvas.getContext('2d');
      firmaCtx.clearRect(0, 0, firmaCanvas.width, firmaCanvas.height);
      firmaCtx.strokeStyle = '#000';
      firmaCtx.lineWidth = 2;
      firmaCtx.lineCap = 'round';

      firmaCanvas.onmousedown = (e) => { dibujando = true; firmaCtx.beginPath(); firmaCtx.moveTo(e.offsetX, e.offsetY); };
      firmaCanvas.onmousemove = (e) => { if(dibujando) { firmaCtx.lineTo(e.offsetX, e.offsetY); firmaCtx.stroke(); } };
      firmaCanvas.onmouseup = () => { dibujando = false; };
      firmaCanvas.onmouseleave = () => { dibujando = false; };

      firmaCanvas.ontouchstart = (e) => { 
        e.preventDefault();
        const rect = firmaCanvas.getBoundingClientRect();
        const touch = e.touches[0];
        dibujando = true; 
        firmaCtx.beginPath(); 
        firmaCtx.moveTo(touch.clientX - rect.left, touch.clientY - rect.top);
      };
      firmaCanvas.ontouchmove = (e) => { 
        e.preventDefault();
        if(dibujando) {
          const rect = firmaCanvas.getBoundingClientRect();
          const touch = e.touches[0];
          firmaCtx.lineTo(touch.clientX - rect.left, touch.clientY - rect.top);
          firmaCtx.stroke();
        }
      };
      firmaCanvas.ontouchend = () => { dibujando = false; };

      // Guardar referencia si es prÃ©stamo
      firmaCanvas.dataset.esPrestamo = esPrestamo;
    }

    function limpiarFirma() {
      firmaCtx.clearRect(0, 0, firmaCanvas.width, firmaCanvas.height);
    }

    function guardarFirma() {
      const firma = firmaCanvas.toDataURL();
      if(firmaCanvas.dataset.esPrestamo === 'true') {
        currentSignaturePrestamo = firma;
        alert('âœ… Firma del cliente guardada correctamente');
      } else {
        currentSignature = firma;
        alert('âœ… Firma guardada correctamente');
      }
      cerrarFirma();
    }

    function cerrarFirma() {
      document.getElementById('firma-modal').style.display = 'none';
    }

    // ===== EXPORTAR EXCEL =====
    function exportarTodoExcel() {
      const wb = XLSX.utils.book_new();
      
      const mantData = allData.mant.map(i => ({
        Fecha: formatDate(i.fecha),
        CÃ³digo: i.codigo,
        Cliente: i.cliente,
        Contacto: i.contacto || '',
        TelÃ©fono: i.telefono || '',
        Estado: i.estado,
        Costo: i.costo || 0,
        Motivo: i.motivo,
        ReparaciÃ³n: i.reparacion || ''
      }));
      const ws1 = XLSX.utils.json_to_sheet(mantData);
      XLSX.utils.book_append_sheet(wb, ws1, "Mantenimiento");

      const prestData = allData.prest.map(i => ({
        Fecha: formatDate(i.fecha),
        CÃ³digo: i.codigo,
        Cliente: i.cliente,
        TelÃ©fono: i.telefono || '',
        Estado: i.estadoGeneral
      }));
      const ws2 = XLSX.utils.json_to_sheet(prestData);
      XLSX.utils.book_append_sheet(wb, ws2, "PrÃ©stamos");

      XLSX.writeFile(wb, `Reporte_Completo_${new Date().toISOString().split('T')[0]}.xlsx`);
    }

    function exportarMantenimientoExcel() {
      const data = allData.mant.map(i => ({
        Fecha: formatDate(i.fecha),
        CÃ³digo: i.codigo,
        Cliente: i.cliente,
        Contacto: i.contacto || '',
        TelÃ©fono: i.telefono || '',
        Estado: i.estado,
        Costo: i.costo || 0,
        'Fecha AlmacÃ©n': i.fechaEntregaAlmacen ? formatDate(i.fechaEntregaAlmacen) : '',
        'Fecha Cliente': i.fechaEntregaCliente ? formatDate(i.fechaEntregaCliente) : '',
        Motivo: i.motivo,
        Observaciones: i.observaciones || '',
        ReparaciÃ³n: i.reparacion || ''
      }));
      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Mantenimiento");
      XLSX.writeFile(wb, `Mantenimiento_${new Date().toISOString().split('T')[0]}.xlsx`);
    }

    function exportarPrestamosExcel() {
      const data = allData.prest.map(i => ({
        Fecha: formatDate(i.fecha),
        CÃ³digo: i.codigo,
        Cliente: i.cliente,
        TelÃ©fono: i.telefono || '',
        Estado: i.estadoGeneral,
        Observaciones: i.observaciones || '',
        Embudo: i.embudo ? 'SÃ­' : 'No',
        Pinza: i.pinza ? 'SÃ­' : 'No',
        Rejilla: i.rejilla ? 'SÃ­' : 'No',
        'CaÃ±o Caliente': i.canoCaliente ? 'SÃ­' : 'No',
        'CaÃ±o Tiempo': i.canoTiempo ? 'SÃ­' : 'No',
        'CaÃ±o FrÃ­a': i.canoFria ? 'SÃ­' : 'No',
        'Tapa Superior': i.tapaSuperior ? 'SÃ­' : 'No',
        'Tapa Frontal': i.tapaFrontal ? 'SÃ­' : 'No',
        'Tapas Laterales': i.tapaLateral ? 'SÃ­' : 'No'
      }));
      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "PrÃ©stamos");
      XLSX.writeFile(wb, `Prestamos_${new Date().toISOString().split('T')[0]}.xlsx`);
    }

    // ===== WHATSAPP =====
    function enviarWhatsApp(telefono, codigo, cliente) {
      if(!telefono) {
        alert('âŒ No hay nÃºmero de telÃ©fono registrado');
        return;
      }
      const msg = `Hola! Su equipo *${codigo}* ya estÃ¡ listo para ser retirado. Saludos - Control de Operaciones`;
      const url = `https://wa.me/${telefono.replace(/\D/g, '')}?text=${encodeURIComponent(msg)}`;
      window.open(url, '_blank');
    }

    // ===== MANTENIMIENTO =====
    function initMant() {
      const form = document.getElementById('form-mantenimiento');
      const table = document.getElementById('tabla-body');
      const search = document.getElementById('search-box');
      const est = document.getElementById('estado');
      let data = [], editId = null, currentFilter = 'todos';

      est.addEventListener('change', () => {
         const v = est.value;
         document.getElementById('div-fecha-almacen').style.display = (v.includes('almacen')||v.includes('cliente'))?'block':'none';
         document.getElementById('div-fecha-cliente').style.display = (v.includes('cliente'))?'block':'none';
      });

      colMant.orderBy("fecha", "desc").onSnapshot(snap => {
        data = []; let cR=0, cA=0, cC=0;
        snap.forEach(d => {
          const item = d.data(); data.push({...item, id:d.id});
          if(item.estado==='recibido') cR++; else if(item.estado==='entregado-almacen') cA++; else if(item.estado==='entregado-cliente') cC++;
        });
        allData.mant = data;
        document.getElementById('count-recibido').innerText = cR;
        document.getElementById('count-almacen').innerText = cA;
        document.getElementById('count-cliente').innerText = cC;
        render();
        updateAlerts();
      });

      window.filterByStatus = (status) => {
        currentFilter = status;
        render();
      };

      function render() {
        const t = search.value.toLowerCase();
        let f = data.filter(i => i.codigo.toLowerCase().includes(t) || i.cliente.toLowerCase().includes(t));
        
        if(currentFilter !== 'todos') {
          f = f.filter(i => i.estado === currentFilter);
        }
        
        table.innerHTML = f.map(i => `<tr>
          <td>${formatDate(i.fecha)}</td><td>${i.codigo}</td><td>${i.cliente}</td><td>${i.contacto || ''}</td>
          <td>S/ ${i.costo || '0.00'}</td><td>${i.motivo.substring(0,50)}...</td><td>${i.estado}</td>
          <td>
            <button class="report" onclick="repMant('${i.id}')">PDF</button>
            ${i.telefono ? `<button class="whatsapp" onclick="enviarWhatsApp('${i.telefono}','${i.codigo}','${i.cliente}')">ğŸ“±</button>` : ''}
            <button class="edit" onclick="edMant('${i.id}')">âœï¸</button>
            <button class="delete" onclick="delMant('${i.id}')">ğŸ—‘</button>
          </td>
        </tr>`).join('');
      }
      search.oninput = render;

      form.onsubmit = async e => {
        e.preventDefault();
        const cod = document.getElementById('codigo').value;
        const obj = {
          fecha: document.getElementById('fecha').value,
          codigo: cod,
          cliente: document.getElementById('cliente').value,
          contacto: document.getElementById('contacto').value,
          telefono: document.getElementById('telefono').value,
          costo: parseFloat(document.getElementById('costo').value) || 0,
          motivo: document.getElementById('motivo').value,
          observaciones: document.getElementById('observaciones').value,
          reparacion: document.getElementById('reparacion').value,
          estado: est.value,
          fechaEntregaAlmacen: document.getElementById('f-almacen').value,
          fechaEntregaCliente: document.getElementById('f-cliente').value,
          firma: currentSignature || '',
          usuarioModificacion: currentUser.email,
          fechaModificacion: new Date().toISOString()
        };

        if(editId) { await colMant.doc(editId).update(obj); cancelEdit(); }
        else {
          const dup = data.find(i => i.codigo.toLowerCase() === cod.toLowerCase());
          if(dup && confirm(`CÃ³digo ${cod} ya existe. Â¿Deseas actualizarlo?`)) await colMant.doc(dup.id).update(obj);
          else if(!dup) await colMant.add(obj);
        }
        form.reset(); 
        document.getElementById('fecha').valueAsDate = new Date();
        currentSignature = null;
      };

      window.edMant = id => {
         const i = data.find(d=>d.id===id);
         document.getElementById('fecha').value = i.fecha;
         document.getElementById('codigo').value = i.codigo;
         document.getElementById('cliente').value = i.cliente;
         document.getElementById('contacto').value = i.contacto||'';
         document.getElementById('telefono').value = i.telefono||'';
         document.getElementById('costo').value = i.costo||'';
         document.getElementById('motivo').value = i.motivo;
         document.getElementById('observaciones').value = i.observaciones||'';
         document.getElementById('reparacion').value = i.reparacion||'';
         est.value = i.estado;
         document.getElementById('f-almacen').value = i.fechaEntregaAlmacen||'';
         document.getElementById('f-cliente').value = i.fechaEntregaCliente||'';
         currentSignature = i.firma || null;
         editId = id;
         document.getElementById('editing-indicator').style.display='block';
         est.dispatchEvent(new Event('change'));
      };
      window.cancelEdit = () => {
        editId=null;
        form.reset();
        currentSignature = null;
        document.getElementById('editing-indicator').style.display='none';
        est.dispatchEvent(new Event('change'));
      };
      window.delMant = id => { if(confirm("Â¿Borrar?")) colMant.doc(id).delete(); };

      window.repMant = id => {
        const item = data.find(d => d.id === id);
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFontSize(18); doc.setFont("helvetica", "bold");
        doc.text('REPORTE DE MANTENIMIENTO', 105, 20, { align: 'center' });
        doc.setLineWidth(0.5); doc.line(20, 25, 190, 25);
        doc.setFontSize(14); doc.text('INFORMACIÃ“N DEL EQUIPO', 20, 35);
        doc.setFontSize(12); let y = 45;

        const info = [
          ['CÃ³digo:', item.codigo],
          ['Cliente:', item.cliente],
          ['Fecha:', formatDate(item.fecha)],
          ['Estado:', item.estado.toUpperCase()],
          ['Costo:', `S/ ${item.costo || '0.00'}`]
        ];
        info.forEach(l => {
          doc.setFont("helvetica", "bold");
          doc.text(l[0], 20, y);
          doc.setFont("helvetica", "normal");
          doc.text(l[1], 70, y);
          y += 10;
        });
        if(item.fechaEntregaAlmacen) {
          doc.setFont("helvetica", "bold");
          doc.text('Fecha Entrega AlmacÃ©n:', 20, y);
          doc.setFont("helvetica", "normal");
          doc.text(formatDate(item.fechaEntregaAlmacen), 70, y);
          y += 10;
        }
        if(item.fechaEntregaCliente) {
          doc.setFont("helvetica", "bold");
          doc.text('Fecha Entrega Cliente:', 20, y);
          doc.setFont("helvetica", "normal");
          doc.text(formatDate(item.fechaEntregaCliente), 70, y);
          y += 10;
        }
        y += 10;
        doc.setFont("helvetica", "bold");
        doc.setFontSize(14);
        doc.text("OBSERVACIONES:", 20, y);
        y += 10;
        doc.setFontSize(12);
        doc.setFont("helvetica", "normal");
        const obs = doc.splitTextToSize(item.observaciones || "N/A", 170);
        doc.text(obs, 20, y);
        y += obs.length * 7 + 10;
        doc.setFont("helvetica", "bold");
        doc.setFontSize(14);
        doc.text("MOTIVO:", 20, y);
        y += 10;
        doc.setFontSize(12);
        doc.setFont("helvetica", "normal");
        const m = doc.splitTextToSize(item.motivo, 170);
        doc.text(m, 20, y);
        y += m.length * 7 + 10;
        doc.setFont("helvetica", "bold");
        doc.setFontSize(14);
        doc.text("TRABAJO REALIZADO:", 20, y);
        y += 10;
        doc.setFontSize(12);
        doc.setFont("helvetica", "normal");
        const r = doc.splitTextToSize(item.reparacion || "N/A", 170);
        doc.text(r, 20, y);
        y += r.length * 7 + 15;

        if(item.firma) {
          if(y > 240) { doc.addPage(); y = 20; }
          doc.setFont("helvetica", "bold");
          doc.text("FIRMA:", 20, y);
          y += 5;
          doc.addImage(item.firma, 'PNG', 20, y, 60, 20);
        }

        doc.save(`Reporte_${item.codigo}.pdf`);
      };
      document.getElementById('fecha').valueAsDate = new Date();
    }

    // ===== STOCK =====
    function initStock() {
      const form = document.getElementById('form-stock');
      const table = document.getElementById('tabla-stock-body');
      const search = document.getElementById('s-search');
      let data = [], editId = null;

      colStock.orderBy("fechaIngreso", "desc").onSnapshot(snap => {
        data = [];
        let enStock = 0, prestados = 0;
        snap.forEach(d => {
          const item = d.data();
          data.push({...item, id:d.id});
          if(item.enPrestamo) prestados++;
          else enStock++;
        });
        allData.stock = data;
        document.getElementById('count-stock').innerText = enStock;
        document.getElementById('count-prestados').innerText = prestados;
        render();
      });

      function render() {
        const t = search.value.toLowerCase();
        const f = data.filter(i => i.codigo.toLowerCase().includes(t) || i.modelo.toLowerCase().includes(t));
        
        table.innerHTML = f.map(i => {
          const accs = ['embudo','pinza','rejilla','canoCaliente','canoTiempo','canoFria','tapaSuperior','tapaFrontal','tapaLateral','empaque']
            .filter(a => i[a])
            .map(a => a.replace('cano','CaÃ±o ').replace('tapa','Tapa '))
            .join(', ');
          
          const statusBadge = i.enPrestamo 
            ? `<span style="background:#17a2b8; color:white; padding:5px 10px; border-radius:12px; font-size:0.85rem;">ğŸ“¤ En PrÃ©stamo</span>`
            : `<span style="background:#28a745; color:white; padding:5px 10px; border-radius:12px; font-size:0.85rem;">âœ… Disponible</span>`;

          return `<tr style="${i.enPrestamo ? 'background:#f8f9fa;' : ''}">
            <td><strong>${i.codigo}</strong></td>
            <td>${i.modelo}</td>
            <td>${i.estado}</td>
            <td>${formatDate(i.fechaIngreso)}</td>
            <td style="font-size:0.85rem;">${accs || 'Sin accesorios'}</td>
            <td>${statusBadge}</td>
            <td>
              ${!i.enPrestamo ? `
                <button class="edit" onclick="edStock('${i.id}')">âœï¸</button>
                <button class="delete" onclick="delStock('${i.id}')">ğŸ—‘</button>
              ` : `<small style="color:#999;">Con ${i.clientePrestamo}</small>`}
            </td>
          </tr>`;
        }).join('');
      }
      search.oninput = render;

      form.onsubmit = async e => {
        e.preventDefault();
        const obj = {
          codigo: document.getElementById('s-codigo').value,
          modelo: document.getElementById('s-modelo').value,
          estado: document.getElementById('s-estado').value,
          fechaIngreso: document.getElementById('s-fecha').value,
          observaciones: document.getElementById('s-obs').value,
          embudo: document.getElementById('s-acc-embudo').checked,
          pinza: document.getElementById('s-acc-pinza').checked,
          rejilla: document.getElementById('s-acc-rejilla').checked,
          canoCaliente: document.getElementById('s-acc-cano-caliente').checked,
          canoTiempo: document.getElementById('s-acc-cano-tiempo').checked,
          canoFria: document.getElementById('s-acc-cano-fria').checked,
          tapaSuperior: document.getElementById('s-acc-tapa-superior').checked,
          tapaFrontal: document.getElementById('s-acc-tapa-frontal').checked,
          tapaLateral: document.getElementById('s-acc-tapa-lateral').checked,
          empaque: document.getElementById('s-acc-empaque').checked,
          enPrestamo: false,
          usuarioCreacion: currentUser.email,
          fechaCreacion: new Date().toISOString()
        };

        if(editId) {
          await colStock.doc(editId).update(obj);
          editId = null;
          document.getElementById('editing-indicator-stock').style.display='none';
        } else {
          const dup = data.find(i => i.codigo.toLowerCase() === obj.codigo.toLowerCase());
          if(dup) {
            alert('âŒ CÃ³digo ya existe');
            return;
          }
          await colStock.add(obj);
        }
        form.reset();
        document.getElementById('s-fecha').valueAsDate = new Date();
      };

      window.edStock = id => {
        const i = data.find(d=>d.id===id);
        document.getElementById('s-codigo').value = i.codigo;
        document.getElementById('s-modelo').value = i.modelo;
        document.getElementById('s-estado').value = i.estado;
        document.getElementById('s-fecha').value = i.fechaIngreso;
        document.getElementById('s-obs').value = i.observaciones||'';
        document.getElementById('s-acc-embudo').checked = i.embudo || false;
        document.getElementById('s-acc-pinza').checked = i.pinza || false;
        document.getElementById('s-acc-rejilla').checked = i.rejilla || false;
        document.getElementById('s-acc-cano-caliente').checked = i.canoCaliente || false;
        document.getElementById('s-acc-cano-tiempo').checked = i.canoTiempo || false;
        document.getElementById('s-acc-cano-fria').checked = i.canoFria || false;
        document.getElementById('s-acc-tapa-superior').checked = i.tapaSuperior || false;
        document.getElementById('s-acc-tapa-frontal').checked = i.tapaFrontal || false;
        document.getElementById('s-acc-tapa-lateral').checked = i.tapaLateral || false;
        document.getElementById('s-acc-empaque').checked = i.empaque || false;
        editId=id;
        document.getElementById('editing-indicator-stock').style.display='block';
      };

      window.cancelEditStock = () => {
        editId=null;
        form.reset();
        document.getElementById('editing-indicator-stock').style.display='none';
      };

      window.delStock = id => { 
        if(confirm("Â¿Eliminar del stock?")) colStock.doc(id).delete(); 
      };

      document.getElementById('s-fecha').valueAsDate = new Date();
    }

    function exportarDispensadoresExcel() {
      const wb = XLSX.utils.book_new();
      
      // Hoja de Stock
      const stockData = allData.stock.map(i => ({
        CÃ³digo: i.codigo,
        Modelo: i.modelo,
        Estado: i.estado,
        'Fecha Ingreso': formatDate(i.fechaIngreso),
        Status: i.enPrestamo ? 'En PrÃ©stamo' : 'Disponible',
        'Cliente PrÃ©stamo': i.clientePrestamo || '',
        Observaciones: i.observaciones || ''
      }));
      const ws1 = XLSX.utils.json_to_sheet(stockData);
      XLSX.utils.book_append_sheet(wb, ws1, "Stock");

      // Hoja de PrÃ©stamos
      const prestData = allData.prest.map(i => ({
        Fecha: formatDate(i.fecha),
        CÃ³digo: i.codigo,
        Cliente: i.cliente,
        TelÃ©fono: i.telefono || '',
        Estado: i.estadoGeneral,
        'Desde Stock': i.desdeStock ? 'SÃ­' : 'No',
        Devuelto: i.devuelto ? 'SÃ­' : 'No'
      }));
      const ws2 = XLSX.utils.json_to_sheet(prestData);
      XLSX.utils.book_append_sheet(wb, ws2, "PrÃ©stamos");

      XLSX.writeFile(wb, `Dispensadores_${new Date().toISOString().split('T')[0]}.xlsx`);
    }

    // ===== PRÃ‰STAMOS CON INTEGRACIÃ“N DE STOCK =====
    function initPrest() {
      const table = document.getElementById('tabla-prestamos-body');
      let data = [], editId = null;

      colPrest.orderBy("fecha", "desc").onSnapshot(snap => {
        data = [];
        snap.forEach(d => data.push({...d.data(), id:d.id}));
        allData.prest = data;
        table.innerHTML = data.map(i => {
          const accs = ['embudo','pinza','rejilla','canoCaliente','canoTiempo','canoFria','tapaSuperior','tapaFrontal','tapaLateral']
            .filter(a => i[a])
            .map(a => a.replace('cano','CaÃ±o ').replace('tapa','Tapa '))
            .join(', ');
          return `<tr>
            <td>${formatDate(i.fecha)}</td>
            <td>${i.codigo}</td>
            <td>${i.cliente}</td>
            <td>${i.telefono || '-'}</td>
            <td>${i.estadoGeneral}</td>
            <td>${accs || 'Ninguno'}</td>
            <td>
              <button class="report" onclick="repPrest('${i.id}')">PDF</button>
              ${i.telefono ? `<button class="whatsapp" onclick="enviarWhatsApp('${i.telefono}','${i.codigo}','${i.cliente}')">ğŸ“±</button>` : ''}
              <button class="edit" onclick="edPrest('${i.id}')">âœï¸</button>
              <button class="delete" onclick="delPrest('${i.id}')">ğŸ—‘</button>
            </td>
          </tr>`;
        }).join('');
      });

      document.getElementById('form-prestamo').onsubmit = async e => {
        e.preventDefault();
        const cod = document.getElementById('p-codigo').value;
        const obj = {
          fecha: document.getElementById('p-fecha').value,
          codigo: cod,
          cliente: document.getElementById('p-cliente').value,
          telefono: document.getElementById('p-telefono').value,
          estadoGeneral: document.getElementById('p-estado').value,
          observaciones: document.getElementById('p-obs').value,
          embudo: document.getElementById('acc-embudo').checked,
          pinza: document.getElementById('acc-pinza').checked,
          rejilla: document.getElementById('acc-rejilla').checked,
          canoCaliente: document.getElementById('acc-cano-caliente').checked,
          canoTiempo: document.getElementById('acc-cano-tiempo').checked,
          canoFria: document.getElementById('acc-cano-fria').checked,
          tapaSuperior: document.getElementById('acc-tapa-superior').checked,
          tapaFrontal: document.getElementById('acc-tapa-frontal').checked,
          tapaLateral: document.getElementById('acc-tapa-lateral').checked,
          usuarioModificacion: currentUser.email,
          fechaModificacion: new Date().toISOString()
        };
        if(editId) {
          await colPrest.doc(editId).update(obj);
          cancelEditPrestamo();
        } else {
          const dup = data.find(i => i.codigo.toLowerCase() === cod.toLowerCase());
          if(dup && confirm(`Equipo en prÃ©stamo. Â¿Actualizar?`)) await colPrest.doc(dup.id).update(obj);
          else if(!dup) await colPrest.add(obj);
        }
        e.target.reset();
        document.getElementById('p-fecha').valueAsDate = new Date();
      };

      window.edPrest = id => {
         const i = data.find(d=>d.id===id);
         document.getElementById('p-fecha').value = i.fecha;
         document.getElementById('p-codigo').value = i.codigo;
         document.getElementById('p-cliente').value = i.cliente;
         document.getElementById('p-telefono').value = i.telefono||'';
         document.getElementById('p-estado').value = i.estadoGeneral;
         document.getElementById('p-obs').value = i.observaciones||'';
         
         document.getElementById('acc-embudo').checked = i.embudo || false;
         document.getElementById('acc-pinza').checked = i.pinza || false;
         document.getElementById('acc-rejilla').checked = i.rejilla || false;
         document.getElementById('acc-cano-caliente').checked = i.canoCaliente || false;
         document.getElementById('acc-cano-tiempo').checked = i.canoTiempo || false;
         document.getElementById('acc-cano-fria').checked = i.canoFria || false;
         document.getElementById('acc-tapa-superior').checked = i.tapaSuperior || false;
         document.getElementById('acc-tapa-frontal').checked = i.tapaFrontal || false;
         document.getElementById('acc-tapa-lateral').checked = i.tapaLateral || false;
         
         editId=id;
         document.getElementById('editing-indicator-prestamo').style.display='block';
      };
      window.cancelEditPrestamo = () => {
        editId=null;
        document.getElementById('form-prestamo').reset();
        document.getElementById('editing-indicator-prestamo').style.display='none';
      };
      window.delPrest = id => { if(confirm("Â¿Borrar?")) colPrest.doc(id).delete(); };
      
      window.repPrest = id => {
        const item = data.find(d => d.id === id);
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFontSize(18); doc.setFont("helvetica", "bold");
        doc.text('REPORTE DE PRÃ‰STAMO', 105, 20, { align: 'center' });
        doc.setLineWidth(0.5); doc.line(20, 25, 190, 25);
        doc.setFontSize(14); doc.text('INFORMACIÃ“N DEL EQUIPO', 20, 35);
        doc.setFontSize(12); let y = 45;

        const info = [
          ['CÃ³digo:', item.codigo],
          ['Cliente:', item.cliente],
          ['Fecha:', formatDate(item.fecha)],
          ['Estado:', item.estadoGeneral.toUpperCase()]
        ];
        info.forEach(l => {
          doc.setFont("helvetica", "bold");
          doc.text(l[0], 20, y);
          doc.setFont("helvetica", "normal");
          doc.text(l[1], 70, y);
          y += 10;
        });
        y += 10;
        doc.setFont("helvetica", "bold");
        doc.setFontSize(14);
        doc.text("OBSERVACIONES:", 20, y);
        y += 10;
        doc.setFontSize(12);
        doc.setFont("helvetica", "normal");
        const obs = doc.splitTextToSize(item.observaciones || "Sin observaciones", 170);
        doc.text(obs, 20, y);
        y += obs.length * 7 + 10;
        doc.setFont("helvetica", "bold");
        doc.setFontSize(14);
        doc.text("ACCESORIOS INCLUIDOS:", 20, y);
        y += 10;
        doc.setFontSize(12);
        doc.setFont("helvetica", "bold");
        doc.text("ACCESORIO", 30, y);
        doc.text("ESTADO", 120, y);
        y += 8;
        doc.setFont("helvetica", "normal");
        ['Embudo','Pinza','Rejilla','CaÃ±o Caliente','CaÃ±o Tiempo','CaÃ±o Fria','Tapa Superior','Tapa Frontal','Tapas Laterales','Empaque'].forEach(a => {
           let key = a.charAt(0).toLowerCase() + a.slice(1).replace(' ', '').replace('Ã±','no').replace('Tapas','Tapa');
           if(key === 'tapaFria') key = 'canoFria';
           doc.text(a, 30, y);
           doc.text(item[key] ? 'SÃ­' : 'No', 120, y);
           y += 7;
        });
        doc.save(`Prestamo_${item.codigo}.pdf`);
      };
      document.getElementById('p-fecha').valueAsDate = new Date();
    }

    // ===== PLANTA =====
    function initPlant() {
      colPlantaEquipos.onSnapshot(snap => {
        const tb = document.getElementById('tabla-maestro-body');
        tb.innerHTML = '';
        snap.forEach(doc => {
          const d = doc.data();
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${d.codigo}</td><td>${d.nombre}</td>
            <td>
              <button class="primary" onclick="openEquipoHistory('${doc.id}')">ğŸ“‚ Ver Historial</button> 
              <button class="delete" onclick="deleteEqPlanta('${doc.id}')">ğŸ—‘ï¸</button>
            </td>`;
          tb.appendChild(tr);
        });
      });

      document.getElementById('form-nuevo-equipo-planta').onsubmit = async e => {
        e.preventDefault();
        const cod = document.getElementById('pl-master-codigo').value;
        const nom = document.getElementById('pl-master-nombre').value;
        const snapshot = await colPlantaEquipos.where("codigo", "==", cod).get();
        if(!snapshot.empty && confirm("El equipo ya existe. Â¿Actualizar nombre?")) {
          await colPlantaEquipos.doc(snapshot.docs[0].id).update({nombre: nom});
        } else if(snapshot.empty) {
          await colPlantaEquipos.add({codigo: cod, nombre: nom});
        }
        e.target.reset();
      };
    }

    let curEqId = null, curEqData = null;

    window.openEquipoHistory = id => {
      curEqId = id;
      colPlantaEquipos.doc(id).get().then(doc => {
        curEqData = doc.data();
        document.getElementById('pl-display-nombre').innerText = curEqData.nombre;
        document.getElementById('pl-display-codigo').innerText = `CÃ“DIGO: ${curEqData.codigo}`;
        document.getElementById('plant-view-master').style.display='none';
        document.getElementById('plant-view-detail').style.display='block';
        loadHistPl(id);
      });
    };

    window.backToPlantMaster = () => {
      document.getElementById('plant-view-master').style.display='block';
      document.getElementById('plant-view-detail').style.display='none';
    };

    function loadHistPl(id) {
      colPlantaHistorial.where("equipoId", "==", id).onSnapshot(snap => {
        const tb = document.getElementById("tabla-historial-body");
        tb.innerHTML = "";
        
        const registros = [];
        snap.forEach(doc => {
          registros.push({ id: doc.id, ...doc.data() });
        });
        
        registros.sort((a, b) => (b.fecha || '').localeCompare(a.fecha || ''));

        registros.forEach(h => {
          tb.innerHTML += `
            <tr>
              <td>${formatDate(h.fecha) || ''}</td>
              <td>${h.tec || ''}</td>
              <td>S/ ${h.costo || '0.00'}</td>
              <td>${h.motivo || ''}</td>
              <td>${h.trabajo || ''}</td>
              <td>
                <button class="delete" onclick="delHistPl('${h.id}')">ğŸ—‘ï¸</button>
              </td>
            </tr>
          `;
        });
      });
    }

    document.getElementById('form-historial-planta').onsubmit = e => {
      e.preventDefault();
      colPlantaHistorial.add({
        equipoId: curEqId,
        fecha: document.getElementById('pl-hist-fecha').value,
        tec: document.getElementById('pl-hist-tecnico').value,
        costo: parseFloat(document.getElementById('pl-hist-costo').value) || 0,
        motivo: document.getElementById('pl-hist-motivo').value,
        trabajo: document.getElementById('pl-hist-trabajo').value,
        usuarioModificacion: currentUser.email,
        fechaModificacion: new Date().toISOString()
      }).then(() => {
        e.target.reset();
        document.getElementById('pl-hist-fecha').valueAsDate = new Date();
      });
    };

    window.delHistPl = id => {
      if(confirm("Â¿Borrar este registro?")) colPlantaHistorial.doc(id).delete();
    };
    
    window.deleteEqPlanta = id => {
      if(confirm("Â¿Borrar equipo e historial completo?")) { 
        colPlantaEquipos.doc(id).delete(); 
        colPlantaHistorial.where("equipoId","==",id).get().then(s => s.forEach(d => d.ref.delete())); 
      }
    };

    document.getElementById('btn-exportar-historial-pdf').onclick = () => {
      colPlantaHistorial.where("equipoId","==",curEqId).get().then(snap => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFontSize(18);
        doc.setFont("helvetica", "bold");
        doc.text('HISTORIAL DE MANTENIMIENTO', 105, 20, { align: 'center' });
        doc.setLineWidth(0.5);
        doc.line(20, 25, 190, 25);
        doc.setFontSize(14);
        doc.text(`EQUIPO: ${curEqData.nombre} (${curEqData.codigo})`, 20, 35);
        doc.setFontSize(12);
        let y = 50;
        
        const registros = [];
        snap.forEach(d => {
          registros.push(d.data());
        });
        registros.sort((a, b) => (a.fecha || '').localeCompare(b.fecha || ''));
        
        let totalCosto = 0;
        registros.forEach(h => {
          if(y > 260) { doc.addPage(); y = 20; }
          doc.setFont("helvetica", "bold");
          doc.text(`${formatDate(h.fecha)} - TÃ©c: ${h.tec || ''} - Costo: S/ ${h.costo || '0.00'}`, 20, y);
          totalCosto += parseFloat(h.costo) || 0;
          y += 7;
          doc.setFont("helvetica", "normal");
          const t = doc.splitTextToSize(`Motivo: ${h.motivo} | Trabajo: ${h.trabajo}`, 170);
          doc.text(t, 20, y);
          y += (t.length * 6) + 10;
        });

        if(y > 260) { doc.addPage(); y = 20; }
        y += 10;
        doc.setFont("helvetica", "bold");
        doc.setFontSize(14);
        doc.text(`COSTO TOTAL: S/ ${totalCosto.toFixed(2)}`, 20, y);
        
        doc.save(`Historial_${curEqData.codigo}.pdf`);
      });
    };

    // ===== REPARTO =====
    function switchTabReparto(tab) {
      if(tab === 'crear') {
        document.getElementById('seccion-crear-ruta').style.display = 'block';
        document.getElementById('seccion-repartidor').style.display = 'none';
        document.getElementById('tab-crear-ruta').style.background = '#007bff';
        document.getElementById('tab-crear-ruta').style.color = 'white';
        document.getElementById('tab-repartidor').style.background = '#f0f0f0';
        document.getElementById('tab-repartidor').style.color = '#666';
        cargarRutasHoy();
      } else {
        document.getElementById('seccion-crear-ruta').style.display = 'none';
        document.getElementById('seccion-repartidor').style.display = 'block';
        document.getElementById('tab-crear-ruta').style.background = '#f0f0f0';
        document.getElementById('tab-crear-ruta').style.color = '#666';
        document.getElementById('tab-repartidor').style.background = '#007bff';
        document.getElementById('tab-repartidor').style.color = 'white';
        cargarVehiculosHoy();
        // 1. FunciÃ³n para mostrar el formulario del equipo al elegir vehÃ­culo
window.mostrarFormularioEquipo = () => {
  const rutaId = document.getElementById('select-vehiculo-repartidor').value;
  const formEquipo = document.getElementById('form-equipo-trabajo');
  
  if (rutaId) {
    formEquipo.style.display = 'block';
    // Limpiamos los nombres anteriores por si acaso
    document.getElementById('nombre-chofer').value = '';
    document.getElementById('nombre-ayudante').value = '';
  } else {
    formEquipo.style.display = 'none';
    document.getElementById('ruta-repartidor-container').style.display = 'none';
  }
};

// 2. FunciÃ³n para confirmar el equipo y desbloquear la ruta
window.confirmarEquipoYCargarRuta = async () => {
  const rutaId = document.getElementById('select-vehiculo-repartidor').value;
  const chofer = document.getElementById('nombre-chofer').value.trim();
  const ayudante = document.getElementById('nombre-ayudante').value.trim();

  if (!chofer || !ayudante) {
    alert('âš ï¸ Por favor ingresa el nombre del chofer y del ayudante.');
    return;
  }

  try {
    // Actualizamos la ruta en Firebase con los nombres del equipo
    await colRutas.doc(rutaId).update({
      chofer: chofer,
      ayudante: ayudante
    });

    // Guardamos info del equipo en el texto de la interfaz
    document.getElementById('ruta-equipo-info').textContent = `ğŸ‘¨â€âœˆï¸ Chofer: ${chofer} | ğŸ‘· Ayudante: ${ayudante}`;
    
    // Ocultamos el formulario de ingreso y mostramos la ruta
    document.getElementById('form-equipo-trabajo').style.display = 'none';
    cargarRutaRepartidor(); // Esta funciÃ³n ya la tienes definida
    
  } catch (error) {
    console.error("Error al actualizar equipo:", error);
    alert('âŒ Error al conectar con la base de datos.');
  }
};
        cargarHistorialReparto();
      }
    }

    function initReparto() {
      document.getElementById('ruta-fecha').valueAsDate = new Date();
      cargarRutasHoy();
    }

    function generarFormularioClientes() {
      const numClientes = parseInt(document.getElementById('ruta-num-clientes').value);
      if(!numClientes || numClientes < 1 || numClientes > 20) {
        alert('Por favor ingresa un nÃºmero vÃ¡lido de clientes (1-20)');
        return;
      }

      const container = document.getElementById('clientes-container');
      container.innerHTML = '';

      for(let i = 1; i <= numClientes; i++) {
        container.innerHTML += `
          <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #007bff;">
            <h4 style="margin-top: 0; color: #007bff;">ğŸ‘¤ Cliente ${i}</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
              <div>
                <label style="font-weight: bold;">Nombre Empresa:</label>
                <input type="text" class="cliente-nombre" data-num="${i}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" required>
              </div>
              <div>
                <label style="font-weight: bold;">Estado de Pago:</label>
                <select class="cliente-pago" data-num="${i}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                  <option value="pagado">âœ… Ya PagÃ³</option>
                  <option value="pendiente">â³ Falta Pagar</option>
                </select>
              </div>
              <div style="grid-column: 1 / -1;">
                <label style="font-weight: bold;">ğŸ“ Link de DirecciÃ³n (Google Maps):</label>
                <input type="url" class="cliente-direccion" data-num="${i}" placeholder="https://maps.google.com/..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
              </div>
              <div>
                <label style="font-weight: bold;">Cantidad de Bidones:</label>
                <input type="number" class="cliente-bidones" data-num="${i}" min="1" value="1" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" required>
              </div>
              <div>
                <label style="font-weight: bold;">Tipo de BidÃ³n:</label>
                <select class="cliente-tipo-bidon" data-num="${i}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                  <option>PEAT</option>
                  <option>A</option>
                  <option>NUEVOS</option>
                  <option>C</option>
                </select>
              </div>
            </div>
          </div>
        `;
      }

      document.getElementById('formulario-clientes').style.display = 'block';
      document.getElementById('form-ruta-base').style.display = 'none';
    }

    function cancelarRuta() {
      document.getElementById('form-ruta-base').reset();
      document.getElementById('ruta-fecha').valueAsDate = new Date();
      document.getElementById('formulario-clientes').style.display = 'none';
      document.getElementById('form-ruta-base').style.display = 'grid';
      editandoRuta = false;
      rutaIdEditar = null;
    }

    async function guardarRuta() {
      const fecha = document.getElementById('ruta-fecha').value;
      const vehiculo = document.getElementById('ruta-vehiculo').value;
      const placa = document.getElementById('ruta-placa').value;
      const numClientes = parseInt(document.getElementById('ruta-num-clientes').value);

      const clientes = [];
      for(let i = 1; i <= numClientes; i++) {
        const nombre = document.querySelector(`.cliente-nombre[data-num="${i}"]`).value;
        const pago = document.querySelector(`.cliente-pago[data-num="${i}"]`).value;
        const direccion = document.querySelector(`.cliente-direccion[data-num="${i}"]`).value;
        const bidones = parseInt(document.querySelector(`.cliente-bidones[data-num="${i}"]`).value);
        const tipoBidon = document.querySelector(`.cliente-tipo-bidon[data-num="${i}"]`).value;

        if(!nombre) {
          alert(`Por favor completa el nombre del Cliente ${i}`);
          return;
        }

        clientes.push({
          numero: i,
          nombre,
          estadoPago: pago,
          direccion,
          cantidadBidones: bidones,
          tipoBidon,
          entregado: false,
          bidonesVaciosRecibidos: 0,
          observaciones: ''
        });
      }

      const ruta = {
        fecha,
        vehiculo,
        placa,
        clientes,
        finalizada: false,
        chofer: '',
        ayudante: '',
        usuarioCreacion: currentUser.email,
        fechaCreacion: new Date().toISOString()
      };

      if(editandoRuta && rutaIdEditar) {
        await colRutas.doc(rutaIdEditar).update(ruta);
        alert('âœ… Ruta actualizada exitosamente');
      } else {
        await colRutas.add(ruta);
        alert('âœ… Ruta creada exitosamente');
      }
      
      cancelarRuta();
      cargarRutasHoy();
    }

    function cargarRutasHoy() {
      const hoy = new Date().toISOString().split('T')[0];
      colRutas.where('fecha', '==', hoy).where('finalizada', '==', false).onSnapshot(snap => {
        const container = document.getElementById('rutas-hoy-container');
        if(snap.empty) {
          container.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">No hay rutas programadas para hoy</p>';
          return;
        }

        container.innerHTML = '';
        snap.forEach(doc => {
          const r = doc.data();
          container.innerHTML += `
            <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #28a745;">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <strong style="font-size: 1.1rem;">ğŸš— ${r.vehiculo}</strong> - ${r.placa}
                  <div style="color: #666; margin-top: 5px;">ğŸ“¦ ${r.clientes.length} clientes asignados</div>
                  ${r.chofer ? `<div style="color: #007bff; margin-top: 3px; font-size: 0.9rem;">ğŸ‘¨â€âœˆï¸ ${r.chofer} | ğŸ‘· ${r.ayudante}</div>` : ''}
                </div>
                <div>
                  <button class="edit" onclick="editarRuta('${doc.id}')" style="margin-right: 5px;">âœï¸ Editar</button>
                  <button class="delete" onclick="eliminarRuta('${doc.id}')">ğŸ—‘ï¸</button>
                </div>
              </div>
            </div>
          `;
        });
      });
    }

    function editarRuta(id) {
      colRutas.doc(id).get().then(doc => {
        const r = doc.data();
        
        document.getElementById('ruta-fecha').value = r.fecha;
        document.getElementById('ruta-vehiculo').value = r.vehiculo;
        document.getElementById('ruta-placa').value = r.placa;
        document.getElementById('ruta-num-clientes').value = r.clientes.length;
        
        editandoRuta = true;
        rutaIdEditar = id;
        
        generarFormularioClientes();
        
        setTimeout(() => {
          r.clientes.forEach((c, i) => {
            const num = i + 1;
            document.querySelector(`.cliente-nombre[data-num="${num}"]`).value = c.nombre;
            document.querySelector(`.cliente-pago[data-num="${num}"]`).value = c.estadoPago;
            document.querySelector(`.cliente-direccion[data-num="${num}"]`).value = c.direccion || '';
            document.querySelector(`.cliente-bidones[data-num="${num}"]`).value = c.cantidadBidones;
            document.querySelector(`.cliente-tipo-bidon[data-num="${num}"]`).value = c.tipoBidon;
          });
        }, 100);
      });
    }

    function eliminarRuta(id) {
      if(confirm('Â¿Eliminar esta ruta?')) {
        colRutas.doc(id).delete();
      }
    }

    function cargarVehiculosHoy() {
      const hoy = new Date().toISOString().split('T')[0];
      colRutas.where('fecha', '==', hoy).where('finalizada', '==', false).get().then(snap => {
        const select = document.getElementById('select-vehiculo-repartidor');
        select.innerHTML = '<option value="">-- Seleccionar vehÃ­culo --</option>';
        snap.forEach(doc => {
          const r = doc.data();
          select.innerHTML += `<option value="${doc.id}">${r.vehiculo} - ${r.placa}</option>`;
        });
      });
    }

    function cargarRutaRepartidor() {
      const rutaId = document.getElementById('select-vehiculo-repartidor').value;
      if(!rutaId) {
        document.getElementById('ruta-repartidor-container').style.display = 'none';
        return;
      }

      currentRutaId = rutaId;
      colRutas.doc(rutaId).onSnapshot(doc => {
        if(!doc.exists) return;
        const ruta = doc.data();
        
        document.getElementById('ruta-vehiculo-nombre').textContent = `${ruta.vehiculo} - ${ruta.placa}`;
        document.getElementById('ruta-fecha-info').textContent = `ğŸ“… ${formatDate(ruta.fecha)} | ${ruta.clientes.length} clientes`;
        document.getElementById('ruta-repartidor-container').style.display = 'block';

        const container = document.getElementById('entregas-container');
        container.innerHTML = '';

        ruta.clientes.forEach((cliente, idx) => {
          const bgColor = cliente.entregado ? '#d4edda' : '#fff';
          const borderColor = cliente.entregado ? '#28a745' : '#007bff';

          container.innerHTML += `
            <div style="background: ${bgColor}; padding: 20px; border-radius: 8px; margin-bottom: 15px; border-left: 5px solid ${borderColor};">
              <div style="display: flex; justify-content: space-between; align-items: start;">
                <div style="flex: 1;">
                  <h3 style="margin: 0 0 10px 0; color: ${borderColor};">
                    ${cliente.entregado ? 'âœ…' : 'ğŸ“¦'} Cliente ${cliente.numero}: ${cliente.nombre}
                  </h3>
                  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 15px;">
                    <div><strong>ğŸ’° Pago:</strong> ${cliente.estadoPago === 'pagado' ? 'âœ… Pagado' : 'â³ Pendiente'}</div>
                    <div><strong>ğŸ“¦ Bidones:</strong> ${cliente.cantidadBidones} x ${cliente.tipoBidon}</div>
                  </div>
                  ${cliente.direccion ? `<div style="margin-bottom: 10px;"><a href="${cliente.direccion}" target="_blank" style="color: #007bff; text-decoration: none;">ğŸ“ Ver en Google Maps â†’</a></div>` : ''}
                  
                  ${!cliente.entregado ? `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;">
                      <div>
                        <label style="font-weight: bold; display: block; margin-bottom: 5px;">Bidones VacÃ­os Recibidos:</label>
                        <input type="number" id="vacios-${idx}" min="0" value="0" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                      </div>
                      <div>
                        <label style="font-weight: bold; display: block; margin-bottom: 5px;">Observaciones:</label>
                        <input type="text" id="obs-${idx}" placeholder="Opcional..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                      </div>
                    </div>
                    <button class="primary" onclick="marcarEntregado(${idx})" style="margin-top: 10px; width: 100%;">âœ… Marcar como Entregado</button>
                  ` : `
                    <div style="background: rgba(40,167,69,0.1); padding: 10px; border-radius: 4px; margin-top: 10px;">
                      <div><strong>Bidones vacÃ­os recibidos:</strong> ${cliente.bidonesVaciosRecibidos}</div>
                      ${cliente.observaciones ? `<div><strong>Observaciones:</strong> ${cliente.observaciones}</div>` : ''}
                    </div>
                  `}
                </div>
              </div>
            </div>
          `;
        });
      });
    }

    async function marcarEntregado(idx) {
      const vacios = parseInt(document.getElementById(`vacios-${idx}`).value) || 0;
      const obs = document.getElementById(`obs-${idx}`).value;

      const doc = await colRutas.doc(currentRutaId).get();
      const ruta = doc.data();
      ruta.clientes[idx].entregado = true;
      ruta.clientes[idx].bidonesVaciosRecibidos = vacios;
      ruta.clientes[idx].observaciones = obs;
      ruta.clientes[idx].horaEntrega = new Date().toISOString();

      await colRutas.doc(currentRutaId).update({ clientes: ruta.clientes });
      alert('âœ… Entrega registrada correctamente');
    }

    async function finalizarRuta() {
      const doc = await colRutas.doc(currentRutaId).get();
      const ruta = doc.data();
      
      const pendientes = ruta.clientes.filter(c => !c.entregado).length;
      if(pendientes > 0) {
        if(!confirm(`AÃºn tienes ${pendientes} entregas pendientes. Â¿Deseas finalizar de todas formas?`)) {
          return;
        }
      }

      // Guardar en historial
      const historial = {
        fecha: ruta.fecha,
        vehiculo: ruta.vehiculo,
        placa: ruta.placa,
        chofer: ruta.chofer,
        ayudante: ruta.ayudante,
        totalClientes: ruta.clientes.length,
        entregados: ruta.clientes.filter(c => c.entregado).length,
        totalBidones: ruta.clientes.reduce((sum, c) => sum + (c.entregado ? c.cantidadBidones : 0), 0),
        totalVaciosRecibidos: ruta.clientes.reduce((sum, c) => sum + c.bidonesVaciosRecibidos, 0),
        clientes: ruta.clientes,
        fechaFinalizacion: new Date().toISOString()
      };

      await colHistorialReparto.add(historial);
      await colRutas.doc(currentRutaId).update({ finalizada: true });
      
      alert('âœ… Ruta finalizada correctamente');
      document.getElementById('select-vehiculo-repartidor').value = '';
      document.getElementById('ruta-repartidor-container').style.display = 'none';
      cargarVehiculosHoy();
      cargarHistorialReparto();
    }

    function cargarHistorialReparto() {
      colHistorialReparto.orderBy('fecha', 'desc').limit(30).onSnapshot(snap => {
        const tbody = document.getElementById('tabla-historial-body');
        tbody.innerHTML = '';
        
        snap.forEach(doc => {
          const h = doc.data();
          tbody.innerHTML += `
            <tr>
              <td><strong>${formatDate(h.fecha)}</strong></td>
              <td>${h.vehiculo} - ${h.placa}</td>
              <td>${h.chofer || 'N/A'}</td>
              <td>${h.totalClientes}</td>
              <td>${h.entregados}</td>
              <td>${h.totalBidones} llenos / ${h.totalVaciosRecibidos} vacÃ­os</td>
              <td>
                <button class="report" onclick="verDetalleHistorial('${doc.id}')">ğŸ‘ï¸ Ver</button>
                <button class="primary" onclick="exportarRutaPDF('${doc.id}')">ğŸ“„ PDF</button>
              </td>
            </tr>
          `;
        });
      });
    }

    function verDetalleHistorial(id) {
      colHistorialReparto.doc(id).get().then(doc => {
        const h = doc.data();
        let detalle = `ğŸ“‹ DETALLE DE RUTA\n\n`;
        detalle += `ğŸ“… Fecha: ${formatDate(h.fecha)}\n`;
        detalle += `ğŸš— VehÃ­culo: ${h.vehiculo} - ${h.placa}\n`;
        detalle += `ğŸ‘¨â€âœˆï¸ Chofer: ${h.chofer || 'N/A'}\n`;
        detalle += `ğŸ‘· Ayudante: ${h.ayudante || 'N/A'}\n`;
        detalle += `ğŸ“Š Clientes: ${h.entregados}/${h.totalClientes} entregados\n\n`;
        detalle += `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n`;
        
        h.clientes.forEach(c => {
          detalle += `${c.entregado ? 'âœ…' : 'âŒ'} Cliente ${c.numero}: ${c.nombre}\n`;
          detalle += `   ğŸ’° ${c.estadoPago === 'pagado' ? 'Pagado' : 'Pendiente'}\n`;
          detalle += `   ğŸ“¦ ${c.cantidadBidones} x ${c.tipoBidon}\n`;
          if(c.entregado) {
            detalle += `   ğŸ”„ VacÃ­os recibidos: ${c.bidonesVaciosRecibidos}\n`;
            if(c.observaciones) detalle += `   ğŸ“ ${c.observaciones}\n`;
          }
          detalle += `\n`;
        });

        alert(detalle);
      });
    }

    function exportarHistorialDia() {
      const hoy = new Date().toISOString().split('T')[0];
      colHistorialReparto.where('fecha', '==', hoy).get().then(snap => {
        if(snap.empty) {
          alert('No hay entregas registradas para hoy');
          return;
        }

        const data = [];
        snap.forEach(doc => {
          const h = doc.data();
          h.clientes.forEach(c => {
            data.push({
              Fecha: formatDate(h.fecha),
              VehÃ­culo: h.vehiculo,
              Placa: h.placa,
              Chofer: h.chofer || '',
              Ayudante: h.ayudante || '',
              Cliente: c.nombre,
              'Estado Pago': c.estadoPago,
              'Bidones Entregados': c.entregado ? c.cantidadBidones : 0,
              'Tipo BidÃ³n': c.tipoBidon,
              'VacÃ­os Recibidos': c.bidonesVaciosRecibidos,
              Entregado: c.entregado ? 'SÃ­' : 'No',
              Observaciones: c.observaciones || ''
            });
          });
        });

        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Reparto_Hoy");
        XLSX.writeFile(wb, `Reparto_${hoy}.xlsx`);
      });
    }

    function exportarRutaPDF(id) {
      colHistorialReparto.doc(id).get().then(doc => {
        const h = doc.data();
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF();
        
        pdf.setFontSize(18); pdf.setFont("helvetica", "bold");
        pdf.text('REPORTE DE RUTA', 105, 20, { align: 'center' });
        pdf.setLineWidth(0.5); pdf.line(20, 25, 190, 25);
        
        pdf.setFontSize(12);
        let y = 35;
        pdf.setFont("helvetica", "bold");
        pdf.text(`Fecha: ${formatDate(h.fecha)}`, 20, y);
        pdf.text(`VehÃ­culo: ${h.vehiculo} - ${h.placa}`, 20, y + 7);
        pdf.text(`Chofer: ${h.chofer || 'N/A'}`, 20, y + 14);
        pdf.text(`Ayudante: ${h.ayudante || 'N/A'}`, 20, y + 21);
        pdf.text(`Entregados: ${h.entregados}/${h.totalClientes}`, 20, y + 28);
        
        y += 40;
        pdf.setFont("helvetica", "normal");
        
        h.clientes.forEach(c => {
          if(y > 260) { pdf.addPage(); y = 20; }
          pdf.setFont("helvetica", "bold");
          pdf.text(`${c.entregado ? 'âœ“' : 'âœ—'} ${c.nombre}`, 20, y);
          pdf.setFont("helvetica", "normal");
          pdf.text(`${c.cantidadBidones} x ${c.tipoBidon} | ${c.estadoPago}`, 30, y + 6);
          if(c.entregado) {
            pdf.text(`VacÃ­os: ${c.bidonesVaciosRecibidos}`, 30, y + 12);
          }
          y += 20;
        });
        
        pdf.save(`Ruta_${formatDate(h.fecha)}_${h.vehiculo}.pdf`);
      });
    }

    // Limpiar historial mayor a 8 meses
    function limpiarHistorialAntiguo() {
      const hace8Meses = new Date();
      hace8Meses.setMonth(hace8Meses.getMonth() - 8);
      const fechaLimite = hace8Meses.toISOString().split('T')[0];

      colHistorialReparto.where('fecha', '<', fechaLimite).get().then(snap => {
        snap.forEach(doc => doc.ref.delete());
        if(!snap.empty) console.log(`ğŸ—‘ï¸ Limpiados ${snap.size} registros antiguos de reparto`);
      });
    }
  </script>
</body>
</html>